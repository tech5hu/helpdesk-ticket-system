<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Ticket {{ ticket['ID'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="page-outer">
<div class="page-wrapper">

    <!-- Home Button -->
    <a href="{{ url_for('home') }}" class="home-btn">← Back To Home Page</a>

    <!-- Header -->
    <header class="dashboard-header">
        <h1>Ticket Details</h1>
        <p class="dashboard-welcome">Viewing Ticket #{{ ticket['ID'] }}</p>
    </header>

    <div class="ticket-summary-card" data-severity="{{ ticket['Severity']|lower }}">
    <div class="ticket-header">
        <h2 class="ticket-title">{{ ticket['Title'] }}</h2>
        <span>ID: {{ ticket['ID'] }}</span>
    </div>

    <div class="ticket-meta">
        <div><strong>Assignee:</strong> {{ ticket['Assignee'] }}</div>
        <div>
            <strong>Severity:</strong>
            {% if ticket['Severity'].lower() == 'low' %}
                <span class="badge-low">Low</span>
            {% elif ticket['Severity'].lower() == 'medium' %}
                <span class="badge-medium">Medium</span>
            {% else %}
                <span class="badge-high">High</span>
            {% endif %}
        </div>
        <div>
            <strong>Status:</strong>
            <span class="status-pill {{ ticket['Status'] | lower | replace(' ', '-') }}">
                {{ ticket['Status'] }}
            </span>
        </div>
        <div><strong>Category:</strong> {{ ticket['Category'] }}</div>
        <div><strong>Submitted:</strong> {{ ticket['Submission Date'] }} {{ ticket['Submission Time'] }}</div>
    </div>

    <div class="ticket-description">
        <label>Description:</label>
        <p>{{ ticket['Description'] }}</p>
    </div>

    {% if ticket['Status'].lower() != 'closed' %}
    <!-- Professional Action Row -->
    <div class="ticket-action-row">
    <button class="btn btn-update" id="updateBtn">Update</button>
    <button class="btn btn-escalate" id="escalateBtn">Escalate</button>
    <button class="btn btn-close"
            onclick="openConfirmModal(
                'Close Ticket',
                'Are you sure you want to close ticket {{ ticket['ID'] }}?',
                '{{ url_for('close_ticket_web', ticket_id=ticket['ID']) }}'
            )">Close</button>
    <button class="btn btn-delete"
            onclick="openConfirmModal(
                'Delete Ticket',
                'Are you sure you want to delete ticket {{ ticket['ID'] }}?',
                '{{ url_for('delete_ticket_web', ticket_id=ticket['ID']) }}'
            )">Delete</button>
</div>
    {% endif %}
</div>

    <!-- Add Comment Card -->
    <div class="add-comment-card">
        <form action="{{ url_for('comment_ticket_web', ticket_id=ticket['ID']) }}" method="POST">
            <label for="comment"><strong>Add Comment</strong></label>
            <textarea id="comment" name="comment" rows="3" required></textarea>
            <button type="submit" class="btn">Add Comment</button>
        </form>
    </div>

    <!-- Comments Section -->
    <div class="comments-section-card">
        <h2>Comments</h2>
        {% if ticket.get('Comments') %}
            {% for comment in ticket['Comments'] %}
                <div class="comment-card">
                    <p>{{ comment['Content'] }}</p>
                    <small class="comment-meta">{{ comment['Author'] }} – {{ comment['Date'] }} {{ comment['Time'] }}</small>
                </div>
            {% endfor %}
        {% else %}
            <p>No comments yet.</p>
        {% endif %}
    </div>

</div>
</div>

<!-- ================== MODALS ================== -->

<!-- Update Modal -->
<div id="updateModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeUpdate">&times;</span>
        <h2>Update Ticket #{{ ticket['ID'] }}</h2>
        <form method="POST" action="{{ url_for('update_ticket_web', ticket_id=ticket['ID']) }}">
            <div class="form-group">
                <label>Title</label>
                <input type="text" name="title" value="{{ ticket['Title'] }}" required>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="5" required>{{ ticket['Description'] }}</textarea>
            </div>

            <div class="form-group">
                <label>Assignee</label>
                <select name="assignee" required>
                    {% for user in assignees %}
                        <option value="{{ user }}" {% if user == ticket['Assignee'] %}selected{% endif %}>{{ user }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Severity</label>
                <select name="severity" required>
                    <option value="Low" {% if ticket['Severity'] == 'Low' %}selected{% endif %}>Low</option>
                    <option value="Medium" {% if ticket['Severity'] == 'Medium' %}selected{% endif %}>Medium</option>
                    <option value="High" {% if ticket['Severity'] == 'High' %}selected{% endif %}>High</option>
                </select>
            </div>

            <div class="form-group">
                <label>Status</label>
                <select name="status" required>
                    <option value="Open" {% if ticket['Status'] == 'Open' %}selected{% endif %}>Open</option>
                    <option value="In Progress" {% if ticket['Status'] == 'In Progress' %}selected{% endif %}>In Progress</option>
                    <option value="Closed" {% if ticket['Status'] == 'Closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>

            <div class="form-group">
                <label>Category</label>
                <input type="text" name="category" value="{{ ticket['Category'] }}" required>
            </div>

            <div class="form-actions" style="text-align: center;">
                <button type="submit" class="btn">Update Ticket</button>
            </div>
        </form>
    </div>
</div>

<!-- Update Confirmation Modal -->
<div id="updateConfirmModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeUpdateConfirm">&times;</span>
    <h3>Confirm Update</h3>
    <p>Are you sure you want to update this ticket?</p>
    <div style="text-align:center; margin-top:12px;">
      <button class="btn" id="confirmUpdateBtn">Yes</button>
      <button class="btn" id="cancelUpdateBtn">No</button>
    </div>
  </div>
</div>

<!-- Generic Confirm Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modalTitle">Confirm Action</h3>
    <p id="modalMessage">Are you sure?</p>
    <div class="modal-buttons">
      <form id="modalForm" method="post">
        <button type="submit" class="btn confirm-btn">Yes</button>
        <button type="button" class="btn cancel-btn" id="cancelModal">Cancel</button>
      </form>
    </div>
  </div>
</div>

<!-- Full-screen Escalate Modal -->
<div id="escalateModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeEscalate">&times;</span>
    <h2>Escalate Ticket #{{ ticket['ID'] }} - {{ ticket['Title'] }}</h2>
    <form id="escalateForm" method="POST" action="{{ url_for('escalate_ticket_web', ticket_id=ticket['ID']) }}">
      <div class="form-group">
        <label>Assign to:</label>
        <select name="assignee" required>
          {% for user in assignees %}
            <option value="{{ user }}" {% if ticket['Assignee'] == user %}selected{% endif %}>{{ user }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-actions" style="text-align:center; margin-top:12px;">
        <button type="submit" class="btn">Escalate</button>
        <button type="button" class="btn" id="cancelEscalateBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="successTitle">Success!</h3>
    <p id="successMessage">Action completed successfully!</p>
    <div style="text-align:center; margin-top:12px;">
      <button class="btn" id="successCloseBtn">Close</button>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='view_ticket.js') }}"></script>

</body>
</html>